<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive TCM Quiz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            background-color: #F7F3EF;
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
            transition: background-color 0.3s;
        }
        .quiz-option {
            transition: background-color 0.2s, color 0.2s, border-color 0.2s;
        }
        .correct {
            background-color: #22c55e !important;
            color: white !important;
            border-color: #16a34a !important;
        }
        .incorrect {
            background-color: #ef4444 !important;
            color: white !important;
            border-color: #dc2626 !important;
        }
        .explanation {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out;
            border-color: transparent; /* Initially transparent border */
        }
        .explanation.show {
            max-height: 500px; /* A large enough height */
            padding: 1rem; /* Apply padding only when visible */
            border-color: #e5e7eb; /* Show border when visible */
        }
    </style>
</head>
<body class="text-gray-800">

    <header id="page-header" style="width: 100%; max-width: 48rem; margin: 1rem auto; padding: 0 1rem; display: flex; justify-content: space-between; align-items: center;">
        <a href="index.html" id="header-link" style="font-size: 1.125rem; font-weight: 600; color: rgb(55, 65, 81); text-decoration: none;">
            &larr; Interactive TCM
        </a>
        <a href="#" onclick="toggleLanguage(event)" class="px-3 py-1 bg-stone-200 text-stone-700 rounded-md text-sm font-bold hover:bg-stone-300 transition-colors">
            Kor / Eng
        </a>
    </header>

    <main class="w-full max-w-3xl mx-auto p-4 md:p-6">
        <!-- 단계 선택 화면 -->
        <div id="stage-selection-container" class="text-center p-8 bg-white rounded-xl shadow-lg">
            <h2 id="stage-title" class="text-3xl font-bold mb-6">단계를 선택하세요</h2>
            <div class="space-y-4">
                <button id="stage-1-button" class="w-full max-w-xs mx-auto bg-blue-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-600 transition-colors">1단계</button>
                <button id="stage-2-button" class="w-full max-w-xs mx-auto bg-green-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-600 transition-colors">2단계</button>
            </div>
        </div>

        <div id="quiz-container" style="display: none;">
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div id="progress-bar" class="w-0 h-2 bg-green-500 transition-all duration-300"></div>
                <div class="p-6 md:p-8">
                    <div id="quiz-header" class="flex justify-between items-center mb-4">
                        <p id="question-counter" class="text-sm font-semibold text-gray-500"></p>
                        <p id="difficulty-badge" class="px-3 py-1 text-xs font-bold rounded-full"></p>
                    </div>
                    <h2 id="question-text" class="text-lg md:text-xl font-bold mb-6 min-h-[100px]"></h2>
                    <div id="options-container" class="space-y-3">
                        <!-- Options will be inserted here -->
                    </div>
                    <div id="feedback-container" class="mt-6">
                        <div id="explanation-box" class="explanation bg-gray-50 border rounded-lg text-left">
                            <h3 id="explanation-title" class="font-bold text-lg mb-2"></h3>
                            <p id="explanation-text" class="text-gray-700"></p>
                        </div>
                    </div>
                </div>
                <div id="quiz-footer" class="bg-gray-50 px-6 py-4 border-t border-gray-200">
                    <button id="next-button" class="w-full bg-gray-800 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-700 transition-colors focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-50" style="display: none;"></button>
                </div>
            </div>
        </div>

        <!-- Result Screen -->
        <div id="result-container" class="text-center p-8 bg-white rounded-xl shadow-lg" style="display: none;">
            <h2 id="result-title" class="text-3xl font-bold mb-2"></h2>
            <p id="result-score" class="text-5xl font-bold text-green-600 mb-4"></p>
            <p id="result-message" class="text-gray-600 mb-8"></p>
            <button id="restart-button" class="bg-gray-800 text-white font-bold py-3 px-6 rounded-lg hover:bg-gray-700 transition-colors"></button>
        </div>
    </main>

    <footer class="text-center py-8 mt-12 text-sm text-gray-500">
        <p>&copy; 2024 Hyungsuk Choi. All Rights Reserved.</p>
    </footer>

    <script>
        // --- FALLBACK DATA ---
        const fallbackData = {
            ko: {
                "하": [{ "id": 998, "difficulty": "하", "question": "예제 문제 1 (하): 30대 여성이 가슴이 두근거리고 불안하며 손바닥에 열감이 있다고 호소합니다. 밤에 식은땀이 나고 입이 마릅니다. 이 경우 가장 적절한 변증은?", "options": { "A": "심음허", "B": "심기허", "C": "심혈허", "D": "심양허" }, "answer": "A", "explanation": "심계와 불안에 더해 오후조열, 오심번열, 야간 도한, 구건 등 음허 내열 증상이 동반되어 심음허로 변증합니다." }],
                "중": [],
                "상": [{ "id": 999, "difficulty": "상", "question": "예제 문제 2 (상): 40대 남성이 후배의 승진 후 스트레스로 화를 잘 내고 관자놀이 두통과 이명을 호소합니다. 혀는 붉고 맥이 현삭합니다. 이 경우 가장 적절한 변증은?", "options": { "A": "위화", "B": "간화", "C": "심화", "D": "담화" }, "answer": "B", "explanation": "명확한 스트레스 사건 이후 발생한 급조이노, 측두통, 현삭맥 등은 간화의 대표적인 증상입니다." }]
            },
            en: {
                "Easy": [{ "id": 998, "difficulty": "Easy", "question": "Example 1 (Easy): A 30-year-old woman complains of palpitations, anxiety, and heat in her palms. She has night sweats and a dry mouth. What is the most likely pattern?", "options": { "A": "Heart Yin Deficiency", "B": "Heart Qi Deficiency", "C": "Heart Blood Deficiency", "D": "Heart Yang Deficiency" }, "answer": "A", "explanation": "Along with palpitations and anxiety, symptoms of yin deficiency heat such as afternoon fever, five-palm heat, night sweats, and dry mouth point towards Heart Yin Deficiency." }],
                "Medium": [],
                "Hard": [{ "id": 999, "difficulty": "Hard", "question": "Example 2 (Hard): A 40-year-old man, after stress from a colleague's promotion, has anger, temporal headaches, and tinnitus. His tongue is red and the pulse is wiry and rapid. What is the most likely pattern?", "options": { "A": "Stomach Fire", "B": "Liver Fire", "C": "Heart Fire", "D": "Gallbladder Fire" }, "answer": "B", "explanation": "Irascibility, temporal headaches, and a wiry/rapid pulse following a clear stress event are classic signs of Liver Fire." }]
            }
        };

        // --- DATA SOURCE ---
        async function loadQuizData(lang) {
           try {
               const response = await fetch(`./organpattern_quiz_${lang}.json`); 
               if (!response.ok) {
                   throw new Error(`HTTP error! status: ${response.status}`);
               }
               const data = await response.json();
               return { data: data, isFallback: false };
           } catch (error) {
               console.warn("Could not load quiz data from file. Using fallback data.", error);
               return { data: fallbackData[lang], isFallback: true };
           }
        }
      
        // --- UI TEXTS ---
        const uiTexts = {
            ko: {
                stageTitle: "단계를 선택하세요",
                stage1: "1단계",
                stage2: "2단계",
                difficulty: { '하': '하', '중': '중', '상': '상' },
                difficultyColors: { '하': 'bg-blue-100 text-blue-800', '중': 'bg-yellow-100 text-yellow-800', '상': 'bg-red-100 text-red-800' },
                questionCounter: (current, total) => `문제 ${current} / ${total}`,
                explanationTitle: "해설",
                nextButton: "다음 문제",
                resultTitle: "퀴즈 완료!",
                resultMessage: "수고하셨습니다! 다시 도전해보세요.",
                restartButton: "단계 선택으로"
            },
            en: {
                stageTitle: "Select a Stage",
                stage1: "Stage 1",
                stage2: "Stage 2",
                difficulty: { 'Easy': 'Easy', 'Medium': 'Medium', 'Hard': 'Hard' },
                difficultyColors: { 'Easy': 'bg-blue-100 text-blue-800', 'Medium': 'bg-yellow-100 text-yellow-800', 'Hard': 'bg-red-100 text-red-800' },
                questionCounter: (current, total) => `Question ${current} / ${total}`,
                explanationTitle: "Explanation",
                nextButton: "Next Question",
                resultTitle: "Quiz Complete!",
                resultMessage: "Well done! Try again to improve your score.",
                restartButton: "Back to Stages"
            }
        };

        // --- QUIZ LOGIC ---
        let currentLang = 'ko';
        let currentUiTexts;
        let quizQuestions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let answerSelected = false;

        const stageSelectionContainer = document.getElementById('stage-selection-container');
        const quizContainer = document.getElementById('quiz-container');
        const resultContainer = document.getElementById('result-container');
        
        const questionCounterEl = document.getElementById('question-counter');
        const difficultyBadgeEl = document.getElementById('difficulty-badge');
        const questionTextEl = document.getElementById('question-text');
        const optionsContainerEl = document.getElementById('options-container');
        const explanationBoxEl = document.getElementById('explanation-box');
        const explanationTitleEl = document.getElementById('explanation-title');
        const explanationTextEl = document.getElementById('explanation-text');
        const nextButtonEl = document.getElementById('next-button');
        const restartButtonEl = document.getElementById('restart-button');
        const progressBarEl = document.getElementById('progress-bar');
        
        function getUrlParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        function toggleLanguage(event) {
            event.preventDefault();
            const newLang = currentLang === 'ko' ? 'en' : 'ko';
            const url = new URL(window.location);
            url.searchParams.set('lang', newLang);
            window.location.href = url.toString();
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // [추가] JSON 데이터의 키가 대소문자가 달라도 값을 찾을 수 있는 헬퍼 함수
        function getPropertyCaseInsensitive(obj, key) {
            if (!obj || !key) return undefined;
            const lowerKey = key.toLowerCase();
            const objKey = Object.keys(obj).find(k => k.toLowerCase() === lowerKey);
            return obj[objKey];
        }

        function selectRandomQuestions(data, counts) {
            let selected = [];
            const difficulties = currentLang === 'ko' ? ['하', '중', '상'] : ['Easy', 'Medium', 'Hard'];
            
            const [easyKey, mediumKey, hardKey] = difficulties;

            // [수정] 대소문자 구분 없이 데이터를 찾도록 getPropertyCaseInsensitive 함수 사용
            const easyData = getPropertyCaseInsensitive(data, easyKey);
            const mediumData = getPropertyCaseInsensitive(data, mediumKey);
            const hardData = getPropertyCaseInsensitive(data, hardKey);

            const easyQuestions = easyData ? shuffleArray([...easyData]).slice(0, counts.easy) : [];
            const mediumQuestions = mediumData ? shuffleArray([...mediumData]).slice(0, counts.medium) : [];
            const hardQuestions = hardData ? shuffleArray([...hardData]).slice(0, counts.hard) : [];

            selected = [...easyQuestions, ...mediumQuestions, ...hardQuestions];
            return shuffleArray(selected);
        }

        function displayQuestion() {
            answerSelected = false;
            explanationBoxEl.classList.remove('show');
            nextButtonEl.style.display = 'none';
            
            const question = quizQuestions[currentQuestionIndex];
            const totalQuestions = quizQuestions.length;
            
            progressBarEl.style.width = `${((currentQuestionIndex) / totalQuestions) * 100}%`;

            questionCounterEl.textContent = currentUiTexts.questionCounter(currentQuestionIndex + 1, totalQuestions);
            
            const difficultyKey = currentLang === 'ko' ? question.difficulty : Object.keys(uiTexts.en.difficulty).find(key => uiTexts.ko.difficulty[question.difficulty] === uiTexts.en.difficulty[key]) || 'Easy';
            difficultyBadgeEl.textContent = currentUiTexts.difficulty[difficultyKey];
            difficultyBadgeEl.className = `px-3 py-1 text-xs font-bold rounded-full ${currentUiTexts.difficultyColors[difficultyKey]}`;
            
            questionTextEl.innerHTML = question.question;
            optionsContainerEl.innerHTML = '';

            const optionsArray = Object.entries(question.options);
            shuffleArray(optionsArray);

            const optionLabels = ['A', 'B', 'C', 'D'];
            optionsArray.forEach(([originalKey, value], index) => {
                const button = document.createElement('button');
                button.className = 'quiz-option w-full text-left p-4 border-2 border-gray-200 rounded-lg hover:bg-gray-100 hover:border-gray-400';
                
                const newLabel = optionLabels[index];
                button.innerHTML = `<span class="font-bold mr-2">${newLabel}.</span> ${value}`;
                
                button.dataset.answer = originalKey; 
                
                button.onclick = (e) => selectAnswer(e.target.closest('button'));
                optionsContainerEl.appendChild(button);
            });
        }

        function selectAnswer(selectedButton) {
            if (answerSelected) return;
            answerSelected = true;

            const selectedAnswer = selectedButton.dataset.answer;
            const correctAnswer = quizQuestions[currentQuestionIndex].answer;
            
            if (selectedAnswer === correctAnswer) {
                score++;
                selectedButton.classList.add('correct');
            } else {
                selectedButton.classList.add('incorrect');
                const correctButton = optionsContainerEl.querySelector(`[data-answer="${correctAnswer}"]`);
                if(correctButton) correctButton.classList.add('correct');
            }
            
            optionsContainerEl.querySelectorAll('.quiz-option').forEach(btn => {
                btn.disabled = true;
                btn.classList.add('cursor-not-allowed');
                btn.classList.remove('hover:bg-gray-100', 'hover:border-gray-400');
            });

            explanationTitleEl.textContent = currentUiTexts.explanationTitle;
            explanationTextEl.innerHTML = quizQuestions[currentQuestionIndex].explanation;
            explanationBoxEl.classList.add('show');

            nextButtonEl.textContent = currentUiTexts.nextButton;
            nextButtonEl.style.display = 'block';
        }

        function showResults() {
            quizContainer.style.display = 'none';
            resultContainer.style.display = 'block';
            
            const totalQuestions = quizQuestions.length;
            const resultScoreText = currentLang === 'ko' 
                ? `${totalQuestions}개 중 ${score}개 정답` 
                : `${score} out of ${totalQuestions} correct`;

            document.getElementById('result-title').textContent = currentUiTexts.resultTitle;
            document.getElementById('result-score').textContent = resultScoreText;
            document.getElementById('result-message').textContent = currentUiTexts.resultMessage;
            restartButtonEl.textContent = currentUiTexts.restartButton;
        }

        function nextQuestion() {
            currentQuestionIndex++;
            if (currentQuestionIndex < quizQuestions.length) {
                displayQuestion();
            } else {
                progressBarEl.style.width = '100%';
                showResults();
            }
        }
        
        async function startQuiz(stage) {
            const { data, isFallback } = await loadQuizData(currentLang);
            if (!data) return;

            let questionCounts;
            if (isFallback) {
                questionCounts = { easy: 1, medium: 0, hard: 1 };
            } else if (stage === 1) {
                questionCounts = { easy: 7, medium: 0, hard: 0 };
            } else {
                questionCounts = { easy: 2, medium: 2, hard: 6 };
            }
            
            quizQuestions = selectRandomQuestions(data, questionCounts);
            
            if (quizQuestions.length === 0) {
                 quizContainer.innerHTML = `<div class="p-8 text-center text-gray-600">출제할 문제가 없습니다. 데이터 파일을 확인해주세요.</div>`;
                 return;
            }

            currentQuestionIndex = 0;
            score = 0;

            stageSelectionContainer.style.display = 'none';
            resultContainer.style.display = 'none';
            quizContainer.style.display = 'block';
            
            displayQuestion();
        }

        function showStageSelection() {
            currentLang = getUrlParam('lang') === 'en' ? 'en' : 'ko';
            currentUiTexts = uiTexts[currentLang];

            document.getElementById('stage-title').textContent = currentUiTexts.stageTitle;
            document.getElementById('stage-1-button').textContent = currentUiTexts.stage1;
            document.getElementById('stage-2-button').textContent = currentUiTexts.stage2;

            quizContainer.style.display = 'none';
            resultContainer.style.display = 'none';
            stageSelectionContainer.style.display = 'block';
        }

        // Event Listeners
        document.getElementById('stage-1-button').addEventListener('click', () => startQuiz(1));
        document.getElementById('stage-2-button').addEventListener('click', () => startQuiz(2));
        nextButtonEl.addEventListener('click', nextQuestion);
        restartButtonEl.addEventListener('click', showStageSelection);

        // Initial Load
        document.addEventListener('DOMContentLoaded', showStageSelection);
    </script>
</body>
</html>
