<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Morpheme Block Combiner</title>
    <!-- Tailwind CSS CDN ë¡œë“œ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ ë° í°íŠ¸ ì„¤ì • */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #ffffff; /* í° ë°”íƒ• */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        /* ë¸”ë¡ ê³µí†µ ìŠ¤íƒ€ì¼: ì¥ë‚œê° ë¸”ë¡ */
        .word-block {
            cursor: grab;
            transition: all 0.15s ease-in-out;
            box-shadow: 0 5px 8px rgba(0, 0, 0, 0.2), 0 2px 4px rgba(0, 0, 0, 0.15);
            border-radius: 0.5rem;
            border-bottom: 6px solid; /* 3D íš¨ê³¼ */
            font-weight: 800; /* êµµì€ ê¸€ì */
            
            /* í•µì‹¬: ë†’ì´ëŠ” ê³ ì •, ë„ˆë¹„ëŠ” ìœ ë™ì  */
            display: inline-flex; 
            align-items: center;
            justify-content: center;
            padding: 0 1.5rem; /* ì¢Œìš° íŒ¨ë”©ìœ¼ë¡œ ë„ˆë¹„ í™•ë³´ */
            height: 90px; /* ëª¨ë“  ë¸”ë¡ ë†’ì´ ê³ ì • */
        }

        .word-block:active { cursor: grabbing; }

        /* ì¤‘ì•™ ë†€ì´íŒ ë“œë¡­ ì¡´ ìŠ¤íƒ€ì¼ */
        #play-area-wrapper {
            transition: all 0.2s;
        }

        /* ë“œë˜ê·¸ ì˜¬ë ¸ì„ ë•Œ ë†€ì´íŒ í•˜ì´ë¼ì´íŠ¸ */
        .slot-highlight {
            background-color: #e0f2fe; /* light-blue-50 */
            border-color: #3b82f6; /* blue-500 */
        }

        /* ì¡°í•© ê²°ê³¼ì˜ í°íŠ¸ ìƒ‰ìƒ ê°•ì œ ì§€ì • */
        .text-dark-contrast { color: #374151; }
        .text-light-contrast { color: white; }

        /* ë§Œí™” ê¸€ì”¨ì²´ ìŠ¤íƒ€ì¼ë§ (Comic Sans MS ë˜ëŠ” ìœ ì‚¬í•œ í°íŠ¸ë¡œ ëŒ€ì²´, Tailwindë¡œ ê·¸ë¦¼ì íš¨ê³¼ ì¶”ê°€) */
        .cartoon-title {
            font-family: 'Comic Sans MS', cursive, sans-serif;
            text-shadow: 3px 3px 0 #1f2937, 5px 5px 0 #9ca3af; /* ë‘êº¼ìš´ ê·¸ë¦¼ì íš¨ê³¼ */
            line-height: 1.1;
        }

        .tts-icon {
            cursor: pointer;
            border: none;
            background: transparent;
            padding: 0;
            margin: 0;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #3b82f6; /* Blue for clarity */
            transition: color 0.15s ease-in-out;
        }

        .tts-icon:hover {
            color: #1d4ed8;
        }

        /* Loading animation for the icon */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="bg-white">

    <div id="app-container" class="w-full max-w-7xl p-4 md:p-8 pt-8">
        <!-- ë§Œí™” ê¸€ì”¨ì²´ ì œëª©: ìƒ‰ìƒ blue-600ìœ¼ë¡œ ë³€ê²½ ë° ì´ëª¨ì§€ í˜„ë¯¸ê²½(ğŸ”¬)ìœ¼ë¡œ ë³€ê²½ -->
        <h1 class="text-4xl md:text-5xl font-extrabold text-center text-blue-600 mb-10 cartoon-title">
            Combine Morpheme Blocks and Make Medical Terms ğŸ”¬
        </h1>

        <!-- items-centerë¡œ ë³€ê²½í•˜ì—¬ ì„¸ë¡œ ì¤‘ì•™ ì •ë ¬ -->
        <div class="flex flex-col lg:flex-row justify-center items-center gap-8">

            <!-- 1. ì™¼ìª½: ì ‘ë‘ì‚¬ ë¸”ë¡ (Draggable) -->
            <div class="w-full lg:w-1/4 p-4 bg-gray-50 rounded-xl shadow-inner min-h-[300px]">
                <div id="prefix-container" class="flex flex-col items-center space-y-3 pt-4">
                    <!-- Prefix blocks will be added here -->
                </div>
            </div>

            <!-- 2. ì¤‘ì•™: ì¡°í•© ê³µê°„ (ë‹¨ì¼ Drop Zone) -->
            <div class="w-full lg:w-1/2 p-6 bg-white rounded-xl shadow-2xl border-4 border-gray-100 min-h-[300px] flex flex-col justify-center items-center text-center">
                
                <!-- ì¡°í•©ëœ ë‹¨ì–´ ì‹œê°í™” ì˜ì—­ (ë†€ì´íŒ) -->
                <div id="play-area-wrapper" class="flex justify-center items-center w-full min-h-[110px] bg-gray-50 rounded-lg p-4 border-2 border-gray-200">
                    
                    <!-- ë¸”ë¡ ì¡°í•© ê²°ê³¼ ë˜ëŠ” í”Œë ˆì´ìŠ¤í™€ë”ê°€ í‘œì‹œë˜ëŠ” ì˜ì—­ -->
                    <div id="combination-display" class="flex justify-center items-center w-full h-full">
                        <!-- JS fills this area. -->
                    </div>
                </div>

                <!-- ì •ì˜ í‘œì‹œ ì˜ì—­ (Definition & Example) -->
                <div id="result-display" class="px-4 mt-6 min-h-[5rem] opacity-0 transition-opacity duration-300">
                    <!-- Definition and example will be rendered here. -->
                </div>
            </div>

            <!-- 3. ì˜¤ë¥¸ìª½: ë‹¨ì–´ ë¸”ë¡ (Draggable) -->
            <div class="w-full lg:w-1/4 p-4 bg-gray-50 rounded-xl shadow-inner min-h-[300px]">
                <div id="stem-container" class="flex flex-col items-center space-y-3 pt-4">
                    <!-- Stem blocks will be added here -->
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- DATA STRUCTURE (New Set) ---
        
        // 9 New Prefixes (Unique colors)
        const prefixes = [
            { id: "oligo", label: "oligo-", meaning: "Few, scanty", class: "bg-orange-600 border-orange-800 text-light-contrast" },
            { id: "poly", label: "poly-", meaning: "Many, much", class: "bg-violet-600 border-violet-800 text-light-contrast" },
            { id: "dys", label: "dys-", meaning: "Abnormal, painful", class: "bg-amber-500 border-amber-700 text-dark-contrast" },
            { id: "a_n", label: "a(n)-", meaning: "Without, lack of", class: "bg-red-500 border-red-700 text-light-contrast" },
            { id: "in", label: "in-", meaning: "Not, into", class: "bg-gray-500 border-gray-700 text-light-contrast" },
            { id: "hyper", label: "hyper-", meaning: "Excessive, above", class: "bg-blue-500 border-blue-700 text-light-contrast" },
            { id: "hypo", label: "hypo-", meaning: "Deficient, below", class: "bg-teal-500 border-teal-700 text-light-contrast" },
            { id: "para", label: "para-", meaning: "Beside, near, abnormal", class: "bg-fuchsia-500 border-fuchsia-700 text-light-contrast" },
        ];

        // 9 New Stems (Unique colors)
        const stems = [
            { id: "somnia", label: "somnia", meaning: "Sleep", class: "bg-lime-400 border-lime-600 text-dark-contrast" },
            { id: "uria", label: "uria", meaning: "Urination", class: "bg-cyan-400 border-cyan-600 text-dark-contrast" },
            { id: "tension", label: "tension", meaning: "Pressure", class: "bg-yellow-400 border-yellow-600 text-dark-contrast" },
            { id: "tonia", label: "tonia", meaning: "Tone, Tension", class: "bg-pink-400 border-pink-600 text-dark-contrast" },
            { id: "kinesia", label: "kinesia", meaning: "Movement", class: "bg-indigo-400 border-indigo-600 text-dark-contrast" },
            { id: "esthesia", label: "esthesia", meaning: "Sensation", class: "bg-red-400 border-red-600 text-dark-contrast" },
            { id: "trophy", label: "trophy", meaning: "Growth, Nourishment", class: "bg-green-400 border-green-600 text-dark-contrast" },
            { id: "phagia", label: "phagia", meaning: "Swallowing, Eating", class: "bg-purple-400 border-purple-600 text-dark-contrast" },
            { id: "pepsia", label: "pepsia", meaning: "Digestion", class: "bg-sky-400 border-sky-600 text-dark-contrast" },
        ];

        // Combined words and definitions map (Leaving out non-standard or non-existent terms)
        const combinations = {
            // SOMNIA
            "oligo_somnia": { word: "Oligosomnia", def: "A condition of insufficient sleep; chronic sleep deprivation.", example: "Chronic pain can lead to oligosomnia, compounding fatigue." },
            "poly_somnia": { word: "Polysomnia", def: "A rare condition characterized by excessive or prolonged sleep periods. (Note: Often used non-medically)", example: "The patient's polysomnia required specialized sleep clinic assessment." },
            "dys_somnia": { word: "Dyssomnia", def: "A broad category of sleep disorders involving difficulty falling asleep or staying asleep, or excessive sleepiness.", example: "Insomnia is the most common type of dyssomnia." },
            "a_n_somnia": { word: "Ansomnia", def: "The inability to sleep; severe insomnia. (Technically 'Insomnia' is more common)", example: "Due to severe stress, the patient suffered from ansomnia for days." },
            "para_somnia": { word: "Parasomnia", def: "A category of sleep disorders involving abnormal and unnatural movements, behaviors, or experiences during sleep.", example: "Sleepwalking and sleep terrors are forms of parasomnia." },
            
            // URIA
            "oligo_uria": { word: "Oliguria", def: "The production of abnormally small amounts of urine (typically <400ml/day in adults).", example: "Oliguria is a common sign of acute kidney injury." },
            "poly_uria": { word: "Polyuria", def: "Excessive or abnormally large production and passage of urine.", example: "Uncontrolled diabetes is a major cause of polyuria." },
            "dys_uria": { word: "Dysuria", def: "Painful or difficult urination.", example: "Dysuria is a primary symptom of a urinary tract infection (UTI)." },
            "a_n_uria": { word: "Anuria", def: "Failure of the kidneys to produce urine (typically <100ml/day in adults).", example: "Anuria is a critical condition requiring immediate medical intervention." },
            
            // TENSION
            "hyper_tension": { word: "Hypertension", def: "Abnormally high blood pressure.", example: "Hypertension is often called a 'silent killer' because it has few symptoms." },
            "hypo_tension": { word: "Hypotension", def: "Abnormally low blood pressure.", example: "A sudden drop in blood pressure can cause symptomatic hypotension." },
            
            // TONIA
            "dys_tonia": { word: "Dystonia", def: "A movement disorder in which a person's muscles contract uncontrollably.", example: "Botox injections can be used to treat focal dystonia." },
            "a_n_tonia": { word: "Atonia", def: "Lack of normal muscle tone or strength.", example: "Uterine atonia is the failure of the uterus to contract after delivery." },
            "hyper_tonia": { word: "Hypertonia", def: "Excessive muscle tone or stiffness, which makes movement difficult.", example: "Hypertonia can be a symptom of a neurological disorder." },
            "hypo_tonia": { word: "Hypotonia", def: "Reduced muscle tone; often described as 'floppy' muscles.", example: "Infant hypotonia may indicate developmental or genetic issues." },

            // KINESIA
            "oligo_kinesia": { word: "Oligokinesia", def: "A neurological disorder characterized by slowness and poverty of movement.", example: "Oligokinesia is a cardinal symptom of Parkinson's disease." },
            "dys_kinesia": { word: "Dyskinesia", def: "Involuntary, erratic, writhing movements of the face, arms, legs, or trunk.", example: "Tardive dyskinesia is a side effect of some long-term medications." },
            "a_n_kinesia": { word: "Akinesia", def: "The loss of ability to move one's muscles voluntarily.", example: "Severe akinesia can render a patient almost immobile." },
            "hyper_kinesia": { word: "Hyperkinesia", def: "Abnormally increased or excessive muscle movement.", example: "ADHD in children is sometimes characterized by hyperkinesia." },
            "hypo_kinesia": { word: "Hypokinesia", def: "Abnormally diminished muscle movement.", example: "Hypokinesia is characterized by reduced speed and amplitude of movement." },
            
            // ESTHESIA
            "dys_esthesia": { word: "Dysesthesia", def: "An abnormal, unpleasant sensation in response to normal stimuli (e.g., pain from a light touch).", example: "Patients with neuropathy often report painful dysesthesia." },
            "a_n_esthesia": { word: "Anesthesia", def: "Total or partial loss of sensation, especially tactile sensibility, induced by drugs.", example: "General anesthesia renders the patient unconscious during surgery." },
            "hyper_esthesia": { word: "Hyperesthesia", def: "Abnormal increase in sensitivity to sensory stimuli.", example: "Sunburn can cause temporary hyperesthesia of the skin." },
            "hypo_esthesia": { word: "Hypoesthesia", def: "A decreased sensitivity to stimulation, or a partial loss of sensation.", example: "Hypoesthesia of the foot is a common warning sign of diabetes." },
            "para_esthesia": { word: "Paresthesia", def: "An abnormal sensation, typically 'pins and needles,' caused by pressure on or damage to peripheral nerves.", example: "Sitting in one position too long can cause transient paresthesia." },

            // TROPHY
            "dys_trophy": { word: "Dystrophy", def: "Any disorder arising from defective or faulty nutrition (e.g., muscular dystrophy).", example: "Muscular dystrophy leads to progressive weakening and wasting of muscles." },
            "a_n_trophy": { word: "Atrophy", def: "The wasting away or decrease in size of a body organ or tissue.", example: "Muscle atrophy occurs after prolonged periods of immobility." },
            "hyper_trophy": { word: "Hypertrophy", def: "The enlargement of an organ or tissue caused by an increase in the size of its cells.", example: "Weightlifting results in muscle hypertrophy." },
            "hypo_trophy": { word: "Hypotrophy", def: "A state of inadequate nutrition or development; underdevelopment of a body part.", example: "Infants with severe malnutrition can exhibit signs of hypotrophy." },

            // PHAGIA
            "poly_phagia": { word: "Polyphagia", def: "Excessive hunger or increased appetite.", example: "Polyphagia, along with polydipsia, is a classic symptom of diabetes." },
            "dys_phagia": { word: "Dysphagia", def: "Difficulty or discomfort in swallowing.", example: "Severe dysphagia may require a feeding tube." },
            "a_n_phagia": { word: "Aphagia", def: "The inability or refusal to swallow.", example: "Aphagia can be caused by neurological damage or severe throat pain." },
            
            // PEPSIA
            "dys_pepsia": { word: "Dyspepsia", def: "Pain or discomfort in the upper abdomen; indigestion.", example: "Antacids can help relieve mild dyspepsia." },
            "a_n_pepsia": { word: "Apepsia", def: "Cessation or failure of the digestive process (rarely used, usually replaced by severe dyspepsia).", example: "Apepsia implies a total lack of digestive ability." },
        };
        
        // --- STATE MANAGEMENT ---
        let currentPrefix = null;
        let currentStem = null;

        // --- DOM ELEMENT REFERENCES ---
        const playAreaWrapperEl = document.getElementById('play-area-wrapper');
        const combinationDisplayEl = document.getElementById('combination-display');
        const resultDisplayEl = document.getElementById('result-display'); // Renamed from definitionEl

        // --- AUDIO/TTS UTILITIES ---
        const apiKey = ""; // API key is provided by the runtime environment
        
        // Converts base64 string to ArrayBuffer
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        // Converts PCM (raw audio data) to a WAV Blob
        function pcmToWav(pcm16, sampleRate) {
            const numChannels = 1;
            const bitsPerSample = 16;
            const byteRate = sampleRate * numChannels * (bitsPerSample / 8);
            const blockAlign = numChannels * (bitsPerSample / 8);
            
            const buffer = new ArrayBuffer(44 + pcm16.length * 2);
            const view = new DataView(buffer);

            // RIFF chunk
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + pcm16.length * 2, true);
            writeString(view, 8, 'WAVE');

            // FMT chunk
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true); // PCM format
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, byteRate, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, bitsPerSample, true);

            // DATA chunk
            writeString(view, 36, 'data');
            view.setUint32(40, pcm16.length * 2, true);

            // Write PCM data
            let offset = 44;
            for (let i = 0; i < pcm16.length; i++, offset += 2) {
                view.setInt16(offset, pcm16[i], true);
            }

            return new Blob([view], { type: 'audio/wav' });
        }

        // Helper for writing strings to DataView
        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }
        
        // Main TTS function
        async function speakWord(word) {
            const icon = document.getElementById('tts-icon');
            if (!icon) return;

            icon.innerHTML = `<svg class="animate-spin h-6 w-6 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;
            icon.disabled = true;

            const maxRetries = 3;
            let attempt = 0;
            
            while (attempt < maxRetries) {
                try {
                    const payload = {
                        contents: [{
                            parts: [{ text: word }]
                        }],
                        generationConfig: {
                            responseModalities: ["AUDIO"],
                            speechConfig: {
                                voiceConfig: {
                                    prebuiltVoiceConfig: { voiceName: "Kore" }
                                }
                            }
                        },
                        model: "gemini-2.5-flash-preview-tts"
                    };

                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    const part = result?.candidates?.[0]?.content?.parts?.[0];
                    const audioData = part?.inlineData?.data;
                    const mimeType = part?.inlineData?.mimeType;

                    if (audioData && mimeType && mimeType.startsWith("audio/")) {
                        const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                        const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 16000;
                        
                        const pcmData = base64ToArrayBuffer(audioData);
                        const pcm16 = new Int16Array(pcmData);
                        const wavBlob = pcmToWav(pcm16, sampleRate);
                        const audioUrl = URL.createObjectURL(wavBlob);
                        
                        const audio = new Audio(audioUrl);
                        audio.play();

                        // Simple Speaker Icon (lucide-react-style SVG)
                        icon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M15.54 8.46a4.99 4.99 0 0 1 0 7.07"></path></svg>`;
                        icon.disabled = false;
                        return;
                    } else {
                        throw new Error("Invalid audio data received.");
                    }

                } catch (error) {
                    console.error("TTS Attempt failed:", error);
                    attempt++;
                    if (attempt < maxRetries) {
                        // Exponential backoff
                        await new Promise(resolve => setTimeout(resolve, 1000 * Math.pow(2, attempt - 1)));
                    }
                }
            }

            // Fallback after retries
            icon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 text-red-500"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>`; // X icon
            setTimeout(() => {
                icon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M15.54 8.46a4.99 4.99 0 0 1 0 7.07"></path></svg>`; // Speaker icon
                icon.disabled = false;
            }, 2000);
        }

        // --- DOM GENERATION AND EVENT REGISTRATION ---
        function createBlock(item, isPrefix) {
            const block = document.createElement('div');
            block.id = item.id;
            block.className = `word-block ${item.class} p-4`;
            
            // Block content: English labels and meanings
            block.innerHTML = `
                <div class="flex flex-col items-center justify-center">
                    <span class="text-2xl font-black">${item.label}</span>
                    <span class="text-xs mt-1 font-semibold opacity-90">${item.meaning}</span>
                </div>
            `;

            // Make all blocks Draggable
            block.setAttribute('draggable', 'true');
            block.addEventListener('dragstart', (e) => {
                const type = isPrefix ? 'prefix' : 'stem';
                // Serialize item data for transfer
                e.dataTransfer.setData('text/plain', JSON.stringify({ ...item, type }));
                e.dataTransfer.effectAllowed = 'copy';
                block.classList.add('opacity-50');
            });
            block.addEventListener('dragend', (e) => {
                block.classList.remove('opacity-50');
            });

            return block;
        }

        // Render original block lists
        function renderBlockLists() {
            const prefixContainer = document.getElementById('prefix-container');
            const stemContainer = document.getElementById('stem-container');
            
            prefixContainer.innerHTML = ''; 
            stemContainer.innerHTML = ''; 

            prefixes.forEach(p => prefixContainer.appendChild(createBlock(p, true)));
            stems.forEach(s => stemContainer.appendChild(createBlock(s, false)));
        }

        // --- PLAY AREA LOGIC ---
        
        // Helper function to handle a(n)- prefix logic
        function getCombinedWordLabel(prefixId, stemLabel) {
            if (prefixId === 'a_n') {
                const firstLetter = stemLabel.charAt(0);
                // Check if the stem starts with a vowel for 'an'
                if (['a', 'e', 'i', 'o', 'u', 'y'].includes(firstLetter)) { // Including 'y' as sometimes a vowel
                    return 'an' + stemLabel;
                } else {
                    return 'a' + stemLabel;
                }
            } else {
                return prefixId + stemLabel;
            }
        }


        // Attach single drop zone listeners
        function attachDropListeners() {
            // DragOver handler
            playAreaWrapperEl.addEventListener('dragover', (e) => {
                e.preventDefault();
                playAreaWrapperEl.classList.add('slot-highlight');
            });
            
            // DragLeave handler
            playAreaWrapperEl.addEventListener('dragleave', (e) => {
                playAreaWrapperEl.classList.remove('slot-highlight');
            });

            // Drop handler (Main Logic)
            playAreaWrapperEl.addEventListener('drop', (e) => {
                e.preventDefault();
                playAreaWrapperEl.classList.remove('slot-highlight');
                
                try {
                    // Receive and parse transferred data
                    const data = JSON.parse(e.dataTransfer.getData('text/plain'));
                    
                    // Update state based on type
                    if (data.type === 'prefix') {
                        currentPrefix = data;
                    } else if (data.type === 'stem') {
                        currentStem = data;
                    }

                    // Check and render immediately after state change
                    checkCombination();

                } catch (error) {
                    console.error("Drop data error:", error);
                    resultDisplayEl.innerHTML = `<span class="text-red-500 font-bold">Drop Error: Please drag a valid block.</span>`;
                    resultDisplayEl.classList.add('opacity-100'); 
                }
            });
        }

        // HTML for individual blocks or placeholders
        function getBlockVisualHTML(itemData, type) {
            if (!itemData) {
                // Placeholder HTML: hidden elements to maintain layout
                return `<div class="flex justify-center items-center h-[90px] w-full mx-1"></div>`;
            }

            // HTML for the actual block component
            let borderClass = '';
            let roundedClass = '';
            
            // Apply visual cut/connection based on block type
            if (type === 'prefix') {
                borderClass = 'border-r-4 border-gray-900';
                roundedClass = 'rounded-l-lg';
            } else { // stem
                borderClass = '';
                roundedClass = 'rounded-r-lg';
            }
            
            // For combined word display, use the prefix ID as the display content, removing trailing hyphen
            const content = itemData.label.replace('-', ''); 

            return `
                <span class="${itemData.class} p-4 md:p-6 ${roundedClass} ${borderClass} h-[90px] flex items-center justify-center text-2xl font-black shadow-lg">
                    ${content}
                </span>
            `;
        }

        // Render content based on current combination state
        function checkCombination() {
            combinationDisplayEl.innerHTML = '';
            resultDisplayEl.classList.remove('opacity-100'); // Start definition hiding
            resultDisplayEl.innerHTML = '';
            
            if (currentPrefix && currentStem) {
                // 1. Full Combination: Render the two connected blocks
                const prefixHTML = getBlockVisualHTML(currentPrefix, 'prefix');
                const stemHTML = getBlockVisualHTML(currentStem, 'stem');

                // Place blocks side-by-side to look connected
                combinationDisplayEl.innerHTML = `
                    <div class="flex justify-center items-center">
                        ${prefixHTML}
                        ${stemHTML}
                    </div>
                `;
                
                // Find and display the definition and example
                const key = `${currentPrefix.id}_${currentStem.id}`;
                const result = combinations[key];
                
                if (result) {
                    // Get the dynamically generated word label (e.g., Anuria or Atrophy)
                    const combinedWord = getCombinedWordLabel(currentPrefix.id, currentStem.label);

                    // Simple Speaker Icon (lucide-react-style SVG)
                    const speakerIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M15.54 8.46a4.99 4.99 0 0 1 0 7.07"></path></svg>`;

                    // Definition: regular font (no italic)
                    // Example: italic font
                    resultDisplayEl.innerHTML = `
                        <p class="text-2xl font-extrabold text-gray-800 flex items-center justify-center">
                            ${combinedWord}
                            <button id="tts-icon" class="tts-icon ml-3" onclick="speakWord('${combinedWord}')">
                                ${speakerIcon}
                            </button>
                        </p>
                        <p class="text-lg mt-2 text-gray-700">${result.def}</p>
                        ${result.example ? `
                            <p class="text-lg italic mt-3 text-gray-700 font-medium">"${result.example}"</p>
                            <p class="text-5xl mt-4">ğŸ§‘â€âš•ï¸</p>
                        ` : ''}
                    `;
                    resultDisplayEl.classList.remove('text-red-500');
                    setTimeout(() => resultDisplayEl.classList.add('opacity-100'), 50); // Show results
                } else {
                    // As requested: just leave the definition area blank for non-standard terms.
                    resultDisplayEl.innerHTML = '';
                    resultDisplayEl.classList.remove('opacity-100'); 
                }

            } else {
                // 2. Incomplete Combination: Render individual block(s) or empty space
                
                const prefixHTML = getBlockVisualHTML(currentPrefix, 'prefix');
                const stemHTML = getBlockVisualHTML(currentStem, 'stem');

                // Use two halves to show where the blocks belong
                combinationDisplayEl.innerHTML = `
                    <div class="flex w-full space-x-2">
                        <div class="w-1/2 flex justify-center items-center">
                            ${prefixHTML}
                        </div>
                        <div class="w-1/2 flex justify-center items-center">
                            ${stemHTML}
                        </div>
                    </div>
                `;
                resultDisplayEl.innerHTML = '';
                resultDisplayEl.classList.remove('opacity-100');
            }
        }

        // Initialization function
        function initializeStateAndArea() {
            renderBlockLists(); // Create draggable source blocks
            attachDropListeners(); // Attach drop listeners to the play area
            // Initial render (empty slots)
            checkCombination(); 
        }
        
        // --- INITIALIZE ---
        window.onload = initializeStateAndArea;
    </script>
</body>
</html>
