<!DOCTYPE html>
<html lang="ko">
<head>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-QC84KCE6C1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-QC84KCE6C1');
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ïò§Ìñâ ÌÉë ÏåìÍ∏∞</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f5f5f4; /* stone-100 */
            overflow: hidden;
            padding: 1rem 0;
        }
        
        .game-container {
            max-width: 1200px;
            width: 95%;
            margin: 1rem auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .score-board {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .marble {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            position: relative;
            margin: 2px;
            box-sizing: border-box;
        }
        
        .marble:hover { transform: scale(1.1); box-shadow: 0 8px 16px rgba(0,0,0,0.3); }
        .marble.selected { transform: scale(1.2); box-shadow: 0 0 20px #ffd700; border: 3px solid #ffd700; }
        .wood, .fire, .earth, .metal, .water { background: linear-gradient(145deg, #ffffff, #e9e9e9); color: black; border: 1px solid #cccccc; }
        
        .game-area { display: flex; gap: 30px; margin-top: 20px; flex-wrap: wrap; }
        
        .play-area {
            flex: 4;
            min-height: 500px;
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 20px;
            position: relative;
            overflow: auto;
            min-width: 350px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 50px;
        }
        
        .right-panel {
            flex: 6;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .next-marbles { background: #f8f9fa; border-radius: 10px; padding: 20px; min-width: 200px; }
        
        #nextMarbles {
            display: flex;
            flex-direction: row;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .marble-stack {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0;
        }
        
        .stack-slot {
            width: 50px;
            height: 50px;
            border: 1px dashed #ccc;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 1px;
        }
        
        .stack-slot:hover { border-color: #a8a29e; background: rgba(214, 211, 209, 0.3); }
        .controls { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        
        /* --- Game Buttons --- */
        button {
            background: none;
            border: none;
            padding: 0;
            margin: 0;
            font-size: 1rem;
            font-weight: 700; /* Bold text */
            cursor: pointer;
            color: #854d0e; /* amber-800 */
            transition: color 0.2s ease;
        }
        button:hover {
            color: #a16207; /* amber-700 */
            text-decoration: underline;
        }
        
        /* --- Language Toggle Button --- */
        .lang-toggle-btn {
            padding: 0.25rem 0.75rem;
            background-color: #e7e5e4;
            color: #57534e;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 700;
            border: none;
            cursor: pointer;
            transition: background-color 0.15s ease-in-out;
        }
        
        .lang-toggle-btn:hover {
            background-color: #d6d3d1;
            text-decoration: none;
        }
        .btn-primary {
            /* All previous styles removed */
        }
        
        .rules { 
            background: #f8f9fa; 
            padding: 20px; 
            border-radius: 10px; 
            text-align: left;
            font-size: 14px;
            line-height: 1.8;
        }
        .rules h3 { margin-top: 0; text-align: center; }
        .rules p { margin: 10px 0; }
        
        .game-over { background: #ffebee; color: #c62828; padding: 15px; border-radius: 10px; margin: 20px 0; text-align: center; font-weight: bold; }

        .score-flash { animation: score-flash 1s ease-in-out; }
        @keyframes score-flash { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.3); color: #a16207; } }
        #bonus-indicator { display: inline-block; color: #a16207; font-weight: bold; margin-left: 5px; }

        .marble-bounce { animation: marble-bounce 0.8s ease-out; }
        @keyframes marble-bounce { 0% { transform: translateY(0); } 50% { transform: translateY(-20px); } 100% { transform: translateY(0); } }

        .sparkle { animation: sparkle 0.8s ease-in-out 2; }
        @keyframes sparkle { 0%, 100% { box-shadow: 0 0 15px 3px rgba(255, 215, 0, 0.9); } 50% { box-shadow: 0 0 15px 3px rgba(72, 209, 204, 0.9); } }
        
        .confetti { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 2000; }
        .confetti-piece { position: absolute; width: 10px; height: 10px; opacity: 0; }
        @keyframes confetti-fall { 0% { transform: translateY(-20px) rotate(0deg); opacity: 1; } 100% { transform: translateY(100vh) rotate(720deg); opacity: 0; } }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 3000;
        }
        .modal-content { background: white; padding: 40px; border-radius: 15px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .bonus-modal-content { background: linear-gradient(45deg, #fbc2eb 0%, #a6c1ee 100%); color: white; padding: 20px 40px; border-radius: 50px; font-size: 1.5em; font-weight: bold; }
    </style>
</head>
<body>
    <header id="page-header" style="width: 100%; max-width: 1200px; margin: 1rem auto; padding: 0 1rem; display: flex; justify-content: space-between; align-items: center;">
        <a href="#" id="header-link" style="font-size: 1.125rem; font-weight: 600; color: rgb(55, 65, 81); text-decoration: none;">
            &larr; Interactive TCM
        </a>
        <button onclick="toggleLanguage(event)" class="lang-toggle-btn">
            Kor / Eng
        </button>
    </header>

    <div class="game-container">
        <div class="header">
            <h1 id="main-title"></h1>
        </div>

        <div class="score-board">
            <div><span id="score-label"></span>: <span id="score">0</span><span id="bonus-indicator"></span></div>
            <div><span id="remaining-label"></span>: <span id="remaining">20</span></div>
            <div class="controls">
                <button id="resetBtn" onclick="resetGame()"></button>
            </div>
        </div>
        
        <div id="gameOver" class="game-over" style="display: none;"></div>
        
        <div class="game-area">
            <div class="play-area" id="playArea">
                <div class="marble-stack" id="stack0" data-stack="0"></div>
                <div class="marble-stack" id="stack1" data-stack="1"></div>
                <div class="marble-stack" id="stack2" data-stack="2"></div>
            </div>
            
            <div class="right-panel">
                <div class="next-marbles">
                    <h3 id="nextMarblesTitle" style="text-align: center; margin-top: 0;"></h3>
                    <div id="nextMarbles"></div>
                </div>
                <div id="rules-container" class="rules"></div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="winModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h2 id="win-title"></h2>
            <p><span id="final-score-label"></span>: <span id="finalScore">0</span></p>
            <button id="play-again-btn" onclick="resetGame()"></button>
        </div>
    </div>
    <div id="bonusModal" class="modal-overlay" style="display: none; background: transparent;">
        <div class="bonus-modal-content" id="bonus-text"></div>
    </div>
    
    <script>
        // --- Translations ---
        const translations = {
            ko: {
                mainTitle: "üîÆ Ïò§Ìñâ ÌÉë ÏåìÍ∏∞ üîÆ",
                scoreLabel: "Ï†êÏàò",
                remainingLabel: "ÎÇ®ÏùÄ Íµ¨Ïä¨",
                resetBtn: "ÏÉà Í≤åÏûÑ",
                gameOver: "Í≤åÏûÑ Ïò§Î≤Ñ! Îçî Ïù¥ÏÉÅ ÎÜìÏùÑ Ïàò ÏûàÎäî Íµ¨Ïä¨Ïù¥ ÏóÜÏäµÎãàÎã§.",
                nextMarblesTitle: "Î∞∞ÏπòÌï† Íµ¨Ïä¨",
                rulesTitle: "Í≤åÏûÑ Í∑úÏπô",
                rule1: "<strong>1. Í≤åÏûÑ ÏãúÏûë:</strong> Ïò§Î•∏Ï™Ω 'Î∞∞ÏπòÌï† Íµ¨Ïä¨'ÏùÑ ÏôºÏ™Ω Í≤åÏûÑ ÌåêÏùò Îπà Í≥≥Ïóê ÏûÑÏùòÎ°ú 3Í∞úÍπåÏßÄ ÎÜìÏïÑ Í≤åÏûÑÏùÑ ÏãúÏûëÌï©ÎãàÎã§.",
                rule2: "<strong>2. Î∞∞Ïπò Í∑úÏπô</strong><br>- <strong>ÏúÑÏ™Ω Î∞∞Ïπò:</strong> Í∏∞Ï°¥ Íµ¨Ïä¨ ÏúÑÏóêÎäî Ïò§ÌñâÏÉÅ ÏûêÏã†ÏùÑ ÏÉù(Áîü)ÌïòÎäî Í≤ÉÎßå Î∂ôÏùº Ïàò ÏûàÏäµÎãàÎã§.<br>- <strong>ÏïÑÎûòÏ™Ω Î∞∞Ïπò:</strong> Í∏∞Ï°¥ Íµ¨Ïä¨ ÏïÑÎûòÏóêÎäî Ïò§ÌñâÏÉÅ ÏûêÏã†ÏùÑ Í∑π(Ââã)ÌïòÎäî Í≤ÉÎßå Î∂ôÏùº Ïàò ÏûàÏäµÎãàÎã§.",
                rule3: "<strong>3. Íµ¨Ïä¨ Ï¢ÖÎ•ò:</strong> Íµ¨Ïä¨ÏùÄ Ïò§Ìñâ(Î™©¬∑Ìôî¬∑ÌÜ†¬∑Í∏à¬∑Ïàò)ÏùÑ Í∏∞Î∞òÏúºÎ°ú ÌïòÎ©∞, ÏûêÏó∞, Ïã†Ï≤¥, Í∞êÏ†ï, ÏÉâ Ï¥ù 20Ï¢ÖÎ•òÍ∞Ä Î¨¥ÏûëÏúÑÎ°ú Îì±Ïû•Ìï©ÎãàÎã§.",
                rule4: "<strong>4. Ï†êÏàò Í∑úÏπô</strong><br>‚ùå ÏûòÎ™ªÎêú ÏúÑÏπòÏóê Î∞∞Ïπò: -2Ï†ê<br>‚úÖ Ïò¨Î∞îÎ•∏ Î∞∞Ïπò: +10Ï†ê<br>üåü Í∞ôÏùÄ Í≥ÑÏó¥(ÏûêÏó∞/Ïã†Ï≤¥/Í∞êÏ†ï/ÏÉâ) Ïó∞ÏÜç Î∞∞Ïπò: +20Ï†ê<br>üíØ Í∞ôÏùÄ Í≥ÑÏó¥Ïùò 5Í∞úÎ•º Î™®Îëê Î∞∞Ïπò: +100Ï†ê",
                rule5: "<strong>5. Ï¢ÖÎ£å Ï°∞Í±¥:</strong> Î™®Îì† Íµ¨Ïä¨ÏùÑ Í∑úÏπôÏóê ÎßûÍ≤å Î∞∞ÏπòÌïòÎ©¥ ÏäπÎ¶¨ÌïòÎ©∞, Îçî Ïù¥ÏÉÅ ÎÜìÏùÑ Ïàò ÏóÜÏùÑ Îïå Í≤åÏûÑ Ïò§Î≤ÑÎê©ÎãàÎã§.",
                winTitle: "üéâ Ï∂ïÌïòÌï©ÎãàÎã§! üéâ",
                finalScoreLabel: "ÏµúÏ¢Ö Ï†êÏàò",
                playAgainBtn: "Îã§Ïãú ÏãúÏûë",
                bonusText: "Î≥¥ÎÑàÏä§ +100Ï†ê!",
                alertSelectMarble: "Î®ºÏ†Ä Íµ¨Ïä¨ÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî!",
                alertInvalidPlacement: "Ïó¨Í∏∞ÏóêÎäî Ïù¥ Íµ¨Ïä¨ÏùÑ ÎÜìÏùÑ Ïàò ÏóÜÏäµÎãàÎã§! (-2Ï†ê)",
                slotInitial: "Ï≤´ Íµ¨Ïä¨ ÎÜìÍ∏∞",
                slotUp: "ÏúÑ",
                slotDown: "ÏïÑÎûò"
            },
            en: {
                mainTitle: "üîÆ Five Elements Tower Stack üîÆ",
                scoreLabel: "Score",
                remainingLabel: "Marbles Left",
                resetBtn: "New Game",
                gameOver: "Game Over! No more moves available.",
                nextMarblesTitle: "Marbles to Place",
                rulesTitle: "Game Rules",
                rule1: "<strong>1. Start Game:</strong> Place a marble from the right panel into an empty slot on the left board to begin.",
                rule2: "<strong>2. Placement Rules</strong><br>- <strong>Place Above:</strong> You can only place a marble that is 'generated by' the existing one according to the Five Elements theory.<br>- <strong>Place Below:</strong> You can only place a marble that 'overcomes' the existing one.",
                rule3: "<strong>3. Marble Types:</strong> Based on the Five Elements (Wood, Fire, Earth, Metal, Water), there are 20 types of marbles across categories like nature, body, emotion, and color.",
                rule4: "<strong>4. Scoring</strong><br>‚ùå Incorrect Placement: -2 Points<br>‚úÖ Correct Placement: +10 Points<br>üåü Consecutive Placement (Same Category): +20 Points<br>üíØ Place all 5 of the Same Category: +100 Points",
                rule5: "<strong>5. End Conditions:</strong> You win by placing all marbles correctly. The game is over when no more valid moves can be made.",
                winTitle: "üéâ Congratulations! üéâ",
                finalScoreLabel: "Final Score",
                playAgainBtn: "Play Again",
                bonusText: "Bonus +100 Points!",
                alertSelectMarble: "Please select a marble first!",
                alertInvalidPlacement: "This marble cannot be placed here! (-2 points)",
                slotInitial: "Place First Marble",
                slotUp: "Up",
                slotDown: "Down"
            }
        };

        let currentLang = 'ko';

        // URL ÌååÎùºÎØ∏ÌÑ∞ÏóêÏÑú Ïñ∏Ïñ¥ ÏÑ§Ï†ï ÏùΩÍ∏∞
        function getLanguageFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const langParam = urlParams.get('lang');
            
            if (langParam) {
                // Îã§ÏñëÌïú Ïñ∏Ïñ¥ ÌååÎùºÎØ∏ÌÑ∞ ÌòïÏãù ÏßÄÏõê
                const normalizedLang = langParam.toLowerCase();
                if (normalizedLang === 'eng' || normalizedLang === 'en' || normalizedLang === 'english') {
                    return 'en';
                } else if (normalizedLang === 'kor' || normalizedLang === 'ko' || normalizedLang === 'korean') {
                    return 'ko';
                }
            }
            
            // Í∏∞Î≥∏Í∞í: ÌïúÍµ≠Ïñ¥
            return 'ko';
        }

        // URL ÌååÎùºÎØ∏ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏ (ÌûàÏä§ÌÜ†Î¶¨Ïóê Ï∂îÍ∞ÄÌïòÏßÄ ÏïäÏùå)
        function updateURLLanguage(lang) {
            const urlParams = new URLSearchParams(window.location.search);
            const langParam = lang === 'en' ? 'eng' : 'kor';
            urlParams.set('lang', langParam);
            
            const newUrl = window.location.pathname + '?' + urlParams.toString();
            window.history.replaceState({}, '', newUrl);
        }

        function applyTranslations() {
            const t = translations[currentLang];
            // Update HTML language attribute
            document.documentElement.lang = currentLang;
            // Update page title
            document.title = currentLang === 'ko' ? 'Ïò§Ìñâ ÌÉë ÏåìÍ∏∞' : 'Five Elements Tower Stack';
            // Update all text elements
            document.getElementById('main-title').innerHTML = t.mainTitle;
            document.getElementById('score-label').textContent = t.scoreLabel;
            document.getElementById('remaining-label').textContent = t.remainingLabel;
            document.getElementById('resetBtn').textContent = t.resetBtn;
            document.getElementById('gameOver').textContent = t.gameOver;
            document.getElementById('nextMarblesTitle').textContent = t.nextMarblesTitle;
            document.getElementById('rules-container').innerHTML = `
                <h3>${t.rulesTitle}</h3>
                <p>${t.rule1}</p>
                <p>${t.rule2}</p>
                <p>${t.rule3}</p>
                <p>${t.rule4}</p>
                <p>${t.rule5}</p>
            `;
            document.getElementById('win-title').innerHTML = t.winTitle;
            document.getElementById('final-score-label').textContent = t.finalScoreLabel;
            document.getElementById('play-again-btn').textContent = t.playAgainBtn;
            document.getElementById('bonus-text').textContent = t.bonusText;
            
            // Update marble tooltips if game is initialized
            if (typeof gameState !== 'undefined' && gameState.nextMarbles) {
                updateMarbleTooltips();
            }
        }

        function updateMarbleTooltips() {
            // Update tooltips for marbles based on current language
            const marbleElements = document.querySelectorAll('.marble[title]');
            marbleElements.forEach(element => {
                const marbleType = element.dataset.marbleType;
                const marbleCategory = element.dataset.marbleCategory;
                if (marbleType && marbleCategory) {
                    const marble = allMarbles.find(m => m.type === marbleType && m.category === marbleCategory);
                    if (marble) {
                        const displayName = currentLang === 'ko' ? marble.name : getEnglishName(marble);
                        const displayCategory = currentLang === 'ko' ? getCategoryName(marble.category) : getEnglishCategoryName(marble.category);
                        element.title = `${displayName} (${displayCategory})`;
                    }
                }
            });
        }

        function getCategoryName(category) {
            const categoryNames = {
                'element': 'ÏõêÏÜå',
                'sense': 'Í∞êÍ∞Å',
                'emotion': 'Í∞êÏ†ï',
                'color': 'ÏÉâÏÉÅ'
            };
            return categoryNames[category] || category;
        }

        function getEnglishCategoryName(category) {
            const categoryNames = {
                'element': 'Element',
                'sense': 'Sense',
                'emotion': 'Emotion',
                'color': 'Color'
            };
            return categoryNames[category] || category;
        }

        function getEnglishName(marble) {
            const englishNames = {
                'Î™©': 'Wood', 'Ìôî': 'Fire', 'ÌÜ†': 'Earth', 'Í∏à': 'Metal', 'Ïàò': 'Water',
                'Îàà': 'Eyes', 'ÌòÄ': 'Tongue', 'ÏûÖÏà†': 'Lips', 'ÏΩî': 'Nose', 'Í∑Ä': 'Ears',
                'Î∂ÑÎÖ∏': 'Anger', 'ÏõÉÏùå': 'Joy', 'ÏÉùÍ∞Å': 'Thought', 'Ïä¨Ìîî': 'Sadness', 'Í≥µÌè¨': 'Fear',
                'ÎÖπÏÉâ': 'Green', 'Îπ®Í∞ï': 'Red', 'ÎÖ∏Îûë': 'Yellow', 'ÌïòÏñë': 'White', 'Í≤ÄÏ†ï': 'Black'
            };
            return englishNames[marble.name] || marble.name;
        }

        function toggleLanguage(event) {
            event.preventDefault();
            currentLang = currentLang === 'ko' ? 'en' : 'ko';
            updateURLLanguage(currentLang);
            applyTranslations();
            updateStackDisplays(); 
        }

        // --- Sound Setup ---
        let audioStarted = false;
        const synth = new Tone.PolySynth(Tone.Synth).toDestination();
        const placeSound = new Tone.MembraneSynth({ octaves: 5, pitchDecay: 0.01 }).toDestination();
        const errorSound = new Tone.Synth({ oscillator: { type: 'square' }, envelope: { attack: 0.01, decay: 0.2, sustain: 0, release: 0.1 } }).toDestination();
        function startAudio() { if (!audioStarted) { Tone.start(); audioStarted = true; } }
        
        // --- Game Data ---
        const allMarbles = [
            { type: 'wood', emoji: 'üå≥', name: 'Î™©', category: 'element' },{ type: 'fire', emoji: 'üî•', name: 'Ìôî', category: 'element' },{ type: 'earth', emoji: '‚õ∞Ô∏è', name: 'ÌÜ†', category: 'element' },{ type: 'metal', emoji: 'üîß', name: 'Í∏à', category: 'element' },{ type: 'water', emoji: 'üíß', name: 'Ïàò', category: 'element' },
            { type: 'wood', emoji: 'üëÄ', name: 'Îàà', category: 'sense' },{ type: 'fire', emoji: 'üëÖ', name: 'ÌòÄ', category: 'sense' },{ type: 'earth', emoji: 'üëÑ', name: 'ÏûÖÏà†', category: 'sense' },{ type: 'metal', emoji: 'üëÉ', name: 'ÏΩî', category: 'sense' },{ type: 'water', emoji: 'üëÇ', name: 'Í∑Ä', category: 'sense' },
            { type: 'wood', emoji: 'üò°', name: 'Î∂ÑÎÖ∏', category: 'emotion' },{ type: 'fire', emoji: 'üòÑ', name: 'ÏõÉÏùå', category: 'emotion' },{ type: 'earth', emoji: 'ü§î', name: 'ÏÉùÍ∞Å', category: 'emotion' },{ type: 'metal', emoji: 'üò¢', name: 'Ïä¨Ìîî', category: 'emotion' },{ type: 'water', emoji: 'üò±', name: 'Í≥µÌè¨', category: 'emotion' },
            { type: 'wood', emoji: 'üü¢', name: 'ÎÖπÏÉâ', category: 'color' },{ type: 'fire', emoji: 'üî¥', name: 'Îπ®Í∞ï', category: 'color' },{ type: 'earth', emoji: 'üü°', name: 'ÎÖ∏Îûë', category: 'color' },{ type: 'metal', emoji: '‚ö™', name: 'ÌïòÏñë', category: 'color' },{ type: 'water', emoji: '‚ö´', name: 'Í≤ÄÏ†ï', category: 'color' }
        ];
        
        const wuxingRules = {
            wood: { generates: 'fire', destroyedBy: 'metal' }, fire: { generates: 'earth', destroyedBy: 'water' }, earth: { generates: 'metal', destroyedBy: 'wood' }, metal: { generates: 'water', destroyedBy: 'fire' }, water: { generates: 'wood', destroyedBy: 'earth' }
        };
        
        let gameState = {};

        function resetGame() {
            gameState = {
                score: 0, selectedMarble: null, selectedMarbleIndex: -1,
                stacks: [ [], [], [] ], marbleQueue: [], nextMarbles: []
            };
            document.getElementById('gameOver').style.display = 'none';
            document.getElementById('winModal').style.display = 'none';
            document.getElementById('bonusModal').style.display = 'none';
            initGame();
        }
        
        function initGame() {
            gameState.marbleQueue = shuffleArray([...allMarbles]);
            updateNextMarbles();
            updateStackDisplays();
            updateUI();
        }

        function placeMarble(stackIndex, position) {
            startAudio();
            const t = translations[currentLang];
            if (!gameState.selectedMarble) { alert(t.alertSelectMarble); return; }
            
            const stack = gameState.stacks[stackIndex];
            const isFirstPlacementInStack = stack.length === 0;

            if (isFirstPlacementInStack) {
                placeSound.triggerAttackRelease("C4", "8n");
                stack.push(gameState.selectedMarble);
            } else {
                if (!canPlaceMarble(stackIndex, position, gameState.selectedMarble.type)) {
                    errorSound.triggerAttackRelease("F#3", "8n");
                    gameState.score -= 2;
                    alert(t.alertInvalidPlacement);
                    updateUI();
                    return;
                }
                placeSound.triggerAttackRelease("C4", "8n");
                
                let pointsToAdd = 10;
                const adjacentMarble = position >= 0 ? stack[stack.length - 1] : stack[0];
                if (gameState.selectedMarble.category === adjacentMarble.category) {
                    pointsToAdd = 20;
                    showBonusEffect(stackIndex, position);
                }

                if (position >= 0) stack.push(gameState.selectedMarble);
                else stack.unshift(gameState.selectedMarble);
                
                gameState.score += pointsToAdd;
                checkFiveInARowBonus(stack, stackIndex);
            }
            
            gameState.marbleQueue.splice(gameState.selectedMarbleIndex, 1);
            gameState.selectedMarble = null;
            updateNextMarbles();
            updateStackDisplays();
            updateUI();
            checkGameEnd();
        }

        function canPlaceMarble(stackIndex, position, marbleType) {
            const stack = gameState.stacks[stackIndex];
            if (stack.length === 0) return true; 
            if (position >= 0) return wuxingRules[stack[stack.length - 1].type].generates === marbleType;
            else return wuxingRules[marbleType].destroyedBy === stack[0].type;
        }

        function checkFiveInARowBonus(stack, stackIndex) {
            for (let i = 0; i <= stack.length - 5; i++) {
                const firstCategory = stack[i].category;
                const bonusSlice = stack.slice(i, i + 5);
                const isBonus = bonusSlice.every(m => m.category === firstCategory && !m.bonusAwarded);
                if (isBonus) {
                    const now = Tone.now();
                    const melody = ["C5", "E5", "G5"];
                    melody.forEach((note, idx) => synth.triggerAttackRelease(note, "16n", now + idx * 0.15));

                    gameState.score += 100;
                    bonusSlice.forEach(m => m.bonusAwarded = true);
                    
                    showBonusModal();
                    
                    setTimeout(() => {
                        const marbleElements = [];
                        const stackEl = document.getElementById(`stack${stackIndex}`);
                        const allMarbleElsInStack = stackEl.querySelectorAll('.marble');

                        const startIndexInDOM = stack.length - 1 - (i + 4);
                        const endIndexInDOM = stack.length - 1 - i;

                        for (let k = startIndexInDOM; k <= endIndexInDOM; k++) {
                            if (allMarbleElsInStack[k]) {
                                marbleElements.push(allMarbleElsInStack[k]);
                            }
                        }
                        
                        applySparkleEffect(marbleElements);
                        marbleElements.forEach((el, k) => {
                            el.classList.add('marble-bounce');
                            el.style.animationDelay = `${k * 0.1}s`;
                            setTimeout(() => {
                               el.classList.remove('marble-bounce');
                               el.style.animationDelay = '';
                            }, 1000); 
                        });
                    }, 50);

                    updateUI();
                    break;
                }
            }
        }

        function checkGameEnd() {
            if (gameState.marbleQueue.length === 0) {
                winAnimation();
                return;
            }
            const canPlaceAny = gameState.nextMarbles.some(marble => 
                gameState.stacks.some((stack, stackIndex) => 
                    canPlaceMarble(stackIndex, stack.length, marble.type) || (stack.length > 0 && canPlaceMarble(stackIndex, -1, marble.type))
                )
            );
            
            if (!canPlaceAny && gameState.stacks.some(s => s.length > 0)) {
                const now = Tone.now();
                const melody = ["G3", "F3", "E3", "D3"];
                melody.forEach((note, i) => synth.triggerAttackRelease(note, "8n", now + i * 0.15));
                document.getElementById('gameOver').style.display = 'block';
            }
        }
        
        function updateStackDisplays() {
            const t = translations[currentLang];
            gameState.stacks.forEach((stack, stackIndex) => {
                const stackElement = document.getElementById(`stack${stackIndex}`);
                stackElement.innerHTML = '';
                
                if (stack.length === 0) {
                    const initialSlot = document.createElement('div');
                    initialSlot.className = 'stack-slot';
                    initialSlot.textContent = t.slotInitial;
                    initialSlot.onclick = () => placeMarble(stackIndex, 0);
                    stackElement.appendChild(initialSlot);
                } else {
                    const topSlot = document.createElement('div');
                    topSlot.className = 'stack-slot';
                    topSlot.textContent = t.slotUp;
                    topSlot.onclick = () => placeMarble(stackIndex, stack.length);
                    stackElement.appendChild(topSlot);
                    
                    for (let i = stack.length - 1; i >= 0; i--) {
                        const marble = stack[i];
                        const marbleElement = document.createElement('div');
                        marbleElement.className = `marble ${marble.type}`;
                        marbleElement.textContent = marble.emoji;
                        marbleElement.dataset.marbleType = marble.type;
                        marbleElement.dataset.marbleCategory = marble.category;
                        const displayName = currentLang === 'ko' ? marble.name : getEnglishName(marble);
                        const displayCategory = currentLang === 'ko' ? getCategoryName(marble.category) : getEnglishCategoryName(marble.category);
                        marbleElement.title = `${displayName} (${displayCategory})`;
                        stackElement.appendChild(marbleElement);
                    }
                    
                    const bottomSlot = document.createElement('div');
                    bottomSlot.className = 'stack-slot';
                    bottomSlot.textContent = t.slotDown;
                    bottomSlot.onclick = () => placeMarble(stackIndex, -1);
                    stackElement.appendChild(bottomSlot);
                }
            });
        }
        
        function updateNextMarbles() {
            const container = document.getElementById('nextMarbles');
            container.innerHTML = '';
            gameState.nextMarbles = gameState.marbleQueue.slice(0, 3);
            gameState.nextMarbles.forEach((marble, index) => {
                const marbleDiv = document.createElement('div');
                marbleDiv.className = `marble ${marble.type}`;
                marbleDiv.dataset.index = index;
                marbleDiv.dataset.marbleType = marble.type;
                marbleDiv.dataset.marbleCategory = marble.category;
                marbleDiv.onclick = () => selectNextMarble(index);
                const displayName = currentLang === 'ko' ? marble.name : getEnglishName(marble);
                const displayCategory = currentLang === 'ko' ? getCategoryName(marble.category) : getEnglishCategoryName(marble.category);
                marbleDiv.title = `${displayName} (${displayCategory})`;
                marbleDiv.textContent = marble.emoji;
                container.appendChild(marbleDiv);
            });
        }
        
        function selectNextMarble(index) {
            startAudio();
            document.querySelectorAll('.marble.selected').forEach(m => m.classList.remove('selected'));
            const marbles = document.querySelectorAll('#nextMarbles .marble');
            if (marbles[index]) {
                marbles[index].classList.add('selected');
                gameState.selectedMarble = gameState.nextMarbles[index];
                gameState.selectedMarbleIndex = index;
            }
        }
        
        function updateUI() {
            document.getElementById('score').textContent = gameState.score;
            document.getElementById('remaining').textContent = gameState.marbleQueue.length;
            document.querySelectorAll('.marble.selected').forEach(m => m.classList.remove('selected'));
        }

        function showBonusEffect(stackIndex, position) {
            const now = Tone.now();
            synth.triggerAttackRelease("C5", "16n", now);
            synth.triggerAttackRelease("G5", "16n", now + 0.1);
            
            const scoreEl = document.getElementById('score');
            const bonusEl = document.getElementById('bonus-indicator');
            scoreEl.classList.add('score-flash');
            bonusEl.textContent = ' X2';

            setTimeout(() => {
                const stackEl = document.getElementById(`stack${stackIndex}`);
                const placedIndex = position >= 0 ? 1 : stackEl.children.length - 2;
                const adjacentIndex = position >= 0 ? 2 : stackEl.children.length - 3;
                applySparkleEffect([stackEl.children[placedIndex], stackEl.children[adjacentIndex]]);
            }, 50);

            setTimeout(() => {
                scoreEl.classList.remove('score-flash');
                bonusEl.textContent = '';
            }, 1000);
        }

        function applySparkleEffect(elements) {
            elements.forEach(el => el && el.classList.add('sparkle'));
            setTimeout(() => elements.forEach(el => el && el.classList.remove('sparkle')), 1600);
        }

        function winAnimation() {
            const now = Tone.now();
            const melody = ["C4", "E4", "G4", "C5", "G4", "E4", "C4"];
            melody.forEach((note, i) => synth.triggerAttackRelease(note, "8n", now + i * 0.15));

            showConfetti();
            const placedMarbles = document.querySelectorAll('.play-area .marble');
            placedMarbles.forEach((marble, i) => {
                marble.classList.add('marble-bounce');
                marble.style.animationDelay = `${i * 0.05}s`;
            });
            
            setTimeout(showWinModal, 2000);
        }

        function showWinModal() {
            document.getElementById('finalScore').textContent = gameState.score;
            document.getElementById('winModal').style.display = 'flex';
        }

        function showBonusModal() {
            const modal = document.getElementById('bonusModal');
            modal.style.display = 'flex';
            setTimeout(() => {
                modal.style.display = 'none';
            }, 2000);
        }

        function showConfetti() {
            const confettiContainer = document.createElement('div');
            confettiContainer.className = 'confetti';
            document.body.appendChild(confettiContainer);
            const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#f9ca24', '#f0932b'];
            for (let i = 0; i < 150; i++) {
                const piece = document.createElement('div');
                piece.className = 'confetti-piece';
                piece.style.left = Math.random() * 100 + 'vw';
                piece.style.background = colors[Math.floor(Math.random() * colors.length)];
                piece.style.animation = `confetti-fall ${2 + Math.random() * 3}s ease-out forwards`;
                piece.style.animationDelay = Math.random() * 2 + 's';
                confettiContainer.appendChild(piece);
            }
            setTimeout(() => {
                if(document.body.contains(confettiContainer)) {
                    document.body.removeChild(confettiContainer);
                }
            }, 5000);
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            // URL ÌååÎùºÎØ∏ÌÑ∞ÏóêÏÑú Ïñ∏Ïñ¥ ÏÑ§Ï†ï ÏùΩÍ∏∞
            currentLang = getLanguageFromURL();
            applyTranslations();
            resetGame();
        });
    </script>
</body>
</html>
